## 장치 컨트롤러와 장치 드라이버

### 장치 컨트롤러

- CPU, 메모리보다 다루기가더 까다롭다.
  - 입출력장치에는 종류가 너무나도 많다.
  - 일반적으로 CPU와 메모리와 데이터 전송률은 높지만 입출력장치의 데이터 전송률은 낮다.
    - 전송률 : 데이터를 얼마나 빨리 교환할 수 있는지를 나타내는 지표
    - CPU와 메모리처럼 전송률이 높은 장치는 1초에도 수많은 데이터를 주고 받지만, 키보드나 마우스와 같이 상대적으로 전송률이 낮은 장치는 데이터를 조금씩 주고 받을 수 있다.
- 그래서 입출력장치는 컴퓨터에 직접 연결되지 않고 장치 컨트롤러라는 하드웨어를 통해 연결된다.
- 장치 컨트롤러는 입출력 제어기, 입출력 모듈등으로도 불린다.

- 장치 컨트롤러는 입출력장치 종류가 많아 정보 규격화가 어려웠던 문제를 해결한다.
- 장치 컨트롤러는 일반적으로 전송률이 높은 CPU와 일반적으로 전송률이 낮은 입출력장치와의 전송률 차이를 데이터 버퍼링으로 완화한다.
- 장치 컨트롤러는 데이터 레지스터, 상태 레지스터, 제어 레지스터로 구성된다.
  그림
  - 데이터 레지스터 : CPU와 입출력 장치 사이에 주고받을 데이터가 담기는 레지스터
  - 상태 레지스터 : 입출력장치가 입출력 작업을 할 준비가 되었는지, 완료되었는지, 오류는 없는지 등의 상태정보가 저장되는 레지스터
  - 제어 레지스터 : 입출력장치가 수행할 내용에 대한 제어 정보와 명령을 저장하는 레지스터

### 장치 드라이버

- 장치 컨트롤러의 동작을 감지하고 제어함으로써 장치 컨트롤러가 컴퓨터 내부와 정보를 주고받을 수 있게 하는 프로그램
- 장치 컨트롤러가 입출력장치 연결을 위한 하드웨어적 통로라면, 장치 드라이버는 입출력장치를 연결하기 위한 소프트웨어적인 통로

## 다양한 입출력 방법

- 장치 컨트롤러가 CPU와 정보를 주고받는 방법은 크게 세 가지로, **프로그램 입출력**, **인터럽트 기반 입출력**, **DMA 입출력**이다.

### 프로그램 입출력

- 프로그램 속 명령어로 입출력장치를 제어하는 방법이다.
- CPU가 프로그램 속 명령어를 실행하는 과정에서 입출력 명령어를 만나면 CPU는 입출력장치에 연결된 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다.

1. CPU 는 하드 디스크 컨트롤러의 제어 레지스터에 쓰기 명령을 보낸다.
2. 하드 디스크 컨트롤러는 하드디스크 상태를 확인한 후, 준비된 상태라면 상태 레지스터에 준비 되었다고 표시한다.
3. CPU는 상태 레지스터를 주기적으로 읽어보며 하드 디스크의 준비 여부를 확인한다. 준비 됐음을 알게 되면 백업할 메모리의 정보를 데이터 레지스터에 쓴다.
   그림

- CPU는 어떻게 장치 컨트롤러의 레지스터를 알 수 있을까?

  - 메모리 맵 입출력 -메모리에 접근하기 위한 주소 공간과 입출력장치에 접근하기 위한 주소 공간을 하나의 주소 공간으로 간주하는 방법이다.
    그림
    - CPU는 메모리의 주소들이나 장치 컨트롤러의 레지스터들이나 모두 똑같이 메모리 주소를 대하듯 하면 된다.
  - 고립형 입출력
    - 메모리를 위한 주소 공간과 입출력장치를 위한 주소 공간을 분리하는 방법이다.
    - CPU는 입출력장치에 접근하기 위해 메모리에 접근하는 명령어와는 다른 입출력 명령어를 사용한다.
      그림

  표

- 인터럽트 기반 입출력

  - 입출력장치에 의한 하드웨어 인터럽트는 *장치 컨트롤러에 의해 발생*한다.
  - CPU는 장치 컨트롤러에 입출력 작업을 명령하고, 장치 컨트롤러가 입출력장치를 제어하며 입출력을 수행하는 동안 CPU는 다른 일을 할 수 있다.
  - 장치 컨트롤러가 입출력 작업을 끝낸 뒤 CPU에게 인터럽트 요청 신호를 보내면 CPU는 하던 일을 백업하고 인터럽트 서비스 루틴을 실행한다.
  - 인터럽트가 동시에 발생하는 경우
    - 플래그 레지스터 속 인터럽트 비트가 활성화되어 있는 경우, 무시할 수 없는 인터럽트 NMI가 발생한 경우 CPU는 우선순위가 높은 인터럽트부터 처리한다.
      그림
    - 프로그래머블 인터럽트 컨트롤러(PIC) : 여러 장치 컨트롤러에 연결되어 장치 컨트롤러에서 보낸 하드웨어 인터럽트 요청들의 우선순위를 판별한 뒤 CPU에 지금 처리해야 할 하드웨어 인터럽트를 알려준다.
    1. PIC가 장치 컨트롤러에서 *인터럽트 요청 신호*를 받아들인다.
    2. PIC는 인터럽트 우선순위를 판단한 뒤 CPU에 처리해야 할 인터럽트 요청 신호를 보낸다.
    3. CPU는 PIC에 *인터럽트 확인 신호*를 보낸다.
    4. PIC는 데이터 버스를 통해 CPU에 *인터럽트 벡터*를 보낸다.
    5. CPU는 인터럽트 벡터를 통해 인터럽트 요청의 주체를 알게 되고, 해당 장치의 *인터럽트 서비스 루틴*을 실행한다.

- DMA 입출력
  - 입출력장치와 메모리 사이에 전송되는 모든 데이터가 반드시 CPU를 거쳐야 한다면 CPU는 부담이 커진다.
  - DMA는 이름 그대로 직접 메모리에 접근할 수 있는 입출력 기능이다.
  - DMA 입출력 과정
    - 1. CPU는 DMA 컨트롤러에 입출력 장치의 주소, 수행할 연산, 읽거나 쓸 메모리의 주소 등과 같은 정보로 입출력 작업을 명령한다.
    - 2. DMA 컨트롤러는 CPU 대신 장치 컨트롤러와 상호작용하며 입출력 작업을 수행한다.
    - 3. 입출력 작업이 끝나면 DMA 컨트롤러는 CPU에 인터럽트를 걸어 작업이 끝났음을 알린다.
         그림
  - 시스템 버스는 동시에 사용이 불가능하다.
    - 그래서 DMA 컨트롤러는 CPU가 시스템 버스를 이용하지 않을 때 조금씩 이용하거나, CPU가 일시적으로 시스템 버스를 이용하지 않도록 허락을 구하고 집중적으로 시스템 버스를 이용한다.
  - 입출력 버스
    - DMA를 위해 시스템 버스를 너무 자주 사용할 때 CPU가 시스템 버스를 이용하지 못하는 문제를 해결
    - DMA 컨트롤러와 장치 컨트롤러들을 입출력 버스라는 별도의 버스에 연결한다.
    - 현대 대부분에 컴퓨터에는 입출력 버스가 있다. (ex. PCI 벗, PCI Express 버스)
